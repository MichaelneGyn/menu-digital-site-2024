import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';

// Carregar vari√°veis de ambiente
dotenv.config();

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;

// Cliente com service role para criar assinaturas
const supabase = createClient(supabaseUrl, supabaseServiceKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
});

async function createTrialSubscription() {
  const userEmail = 'teste@menudigital.com';
  
  try {
    console.log(`üîç Procurando usu√°rio: ${userEmail}`);
    
    // 1. Buscar o usu√°rio pelo email
    const { data: users, error: userError } = await supabase.auth.admin.listUsers();
    
    if (userError) {
      console.error('‚ùå Erro ao buscar usu√°rios:', userError);
      return;
    }
    
    const user = users.users.find(u => u.email === userEmail);
    
    if (!user) {
      console.error(`‚ùå Usu√°rio n√£o encontrado: ${userEmail}`);
      return;
    }
    
    console.log(`‚úÖ Usu√°rio encontrado: ${user.id}`);
    
    // 2. Verificar se j√° tem assinatura ativa
    const { data: existingSubscriptions, error: subError } = await supabase
      .from('subscriptions')
      .select('*')
      .eq('user_id', user.id)
      .eq('status', 'active');
    
    if (subError) {
      console.error('‚ùå Erro ao verificar assinaturas:', subError);
      return;
    }
    
    if (existingSubscriptions && existingSubscriptions.length > 0) {
      console.log('‚ö†Ô∏è Usu√°rio j√° possui assinatura ativa:', existingSubscriptions[0]);
      return;
    }
    
    // 3. Criar nova assinatura trial de 3 dias
    const startDate = new Date();
    const endDate = new Date();
    endDate.setDate(endDate.getDate() + 3);
    
    const { data: newSubscription, error: createError } = await supabase
      .from('subscriptions')
      .insert({
        user_id: user.id,
        plan: 'free',
        status: 'active',
        start_date: startDate.toISOString(),
        end_date: endDate.toISOString()
      })
      .select()
      .single();
    
    if (createError) {
      console.error('‚ùå Erro ao criar assinatura:', createError);
      return;
    }
    
    console.log('üéâ Assinatura trial criada com sucesso!');
    console.log('üìã Detalhes:', {
      id: newSubscription.id,
      user_id: newSubscription.user_id,
      plan: newSubscription.plan,
      status: newSubscription.status,
      start_date: newSubscription.start_date,
      end_date: newSubscription.end_date
    });
    
  } catch (error) {
    console.error('‚ùå Erro geral:', error);
  }
}

// Executar o script
createTrialSubscription()
  .then(() => {
    console.log('\nüéâ Script conclu√≠do!');
    process.exit(0);
  })
  .catch((error) => {
    console.error('‚ùå Erro no script:', error);
    process.exit(1);
  });